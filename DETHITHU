create database DeThiThu
use DeThiThu

create table GiangVien(
MaGiangVien int primary key,
TenGiangVien varchar(100) not null,
BoMon varchar(50) not null,
Email varchar(50),
NamSinh int
)
create table HoiDongDATN(
MaHoiDong int primary key,
TenHoiDong varchar(50) not null,
ChuyenNganh varchar(20) not null,
HocKy varchar(20)
);
create table DanhSachHoiDong
( MaGiangVien int,
MaHoiDong int,
VaiTro Varchar(20) not null ,
GhiChu varchar(20),
primary key (MaGiangVien,MaHoiDong),
Foreign key (MaGiangVien) references GiangVien (MaGiangVien),
Foreign key (MaHoiDong) references HoiDongDATN (MaHoiDong)

);
-- Thu TUC = STORES PROCEDURE(ALL)
-- O PHAN KHAI LA KHONG CO NGOAC
-- EXEC 
-- EXEC
-- AS BEGIN END
-- KHUNG NHIN = VIEW THI KHONG CO BEGIN END  ( CHI DUNG DUOC SELECT, K BIEN, K IF ELSE)
-- HAM - FUNCTION (K DUNG DC INSERT,UPDATE,DELETE, PRINT)
-- PHAN KHAI BAO THAM SO -- LUON LUON CO NGOAC ()
-- CAU 1
-- BANG1 
CREATE PROCEDURE THEMGIANGVIEN
@MaGiangVien int,
@TenGiangVien varchar(100),
@BoMon varchar(50),
@Email varchar(50),
@NamSinh INT
AS 
BEGIN 
	IF @MaGiangVien IS NULL OR @TenGiangVien IS NULL OR @NamSinh IS NULL
	PRINT 'VUI LONG NHAP DU DU LIEU'
	ELSE IF EXISTS (SELECT 1 FROM GIANGVIEN WHERE MaGiangVien = @MaGiangVien)
	PRINT 'MA GIANG VIEN DA TON TAI, VUI LONG NHAP LAI'
	ELSE 
	BEGIN 
		INSERT INTO GIANGVIEN(MaGiangVien,TenGiangVien,BoMon,Email,NamSinh)
		VALUES(@MaGiangVien,@TenGiangVien,@BoMon,@Email,@NamSinh)
		PRINT 'THEM GIANG VIEN MOI THANH CONG '
	END
	
END

EXEC THEMGIANGVIEN 4,'HUONGTTM','COM','123@GMAIL',1999
EXEC THEMGIANGVIEN 5,'HUONGTTM5','COM','123@GMAIL',2007
EXEC THEMGIANGVIEN 6,'HUONGTTM9','COM','123@GMAIL',1999

EXEC THEMGIANGVIEN 7,'NGUYENVV6','COM','NGUYENVV6@FPT.EDU.VN',1998
EXEC THEMGIANGVIEN 8,'HAHQ11','COM','HAHQ11@FE.EDU.VN',1998

SELECT * FROM GIANGVIEN 
-- BANG 2
INSERT INTO HoiDongDATN(MaHoiDong,TenHoiDong,ChuyenNganh,HocKy) VALUES (1,'PTCD','IT','FA')
INSERT INTO HoiDongDATN(MaHoiDong,TenHoiDong,ChuyenNganh,HocKy) VALUES (2,'POLY','DM','FA')
INSERT INTO HoiDongDATN(MaHoiDong,TenHoiDong,ChuyenNganh,HocKy) VALUES (3,'FPT','GD','FA')
-- BANG 3
INSERT INTO DanhSachHoiDong( MaGiangVien,MaHoiDong,VaiTro,GhiChu) VALUES (6,1,'GV','KHONGCOGI')
INSERT INTO DanhSachHoiDong( MaGiangVien,MaHoiDong,VaiTro,GhiChu) VALUES (2,2,'GVNE','KHONGCOGI')
INSERT INTO DanhSachHoiDong( MaGiangVien,MaHoiDong,VaiTro,GhiChu) VALUES (3,3,'GVHIHI','KHONGCOGI')
 SELECT * FROM DanhSachHoiDong 
--CAU 2 
-- NGAYSINH DATE 2007-15-09 YEAR(NGAYSINH) -> OUTPUT 2007
-- MONTH(NGAYSINH) -> OUTPUT 9
-- DAY(NGAYSINH) -> OUTPUT 15
-- YEAR()- LAY RA SO NAM
-- GETDATE()- LAY RA NGAY THANG HIEN TAI 2024-10-12
CREATE VIEW V_GIANGVIEN
AS
SELECT MaGiangVien ,TenGiangVien, BoMon , (YEAR(GETDATE()) - (YEAR(NamSinh)) AS Tuoi
FROM GIANGVIEN 

SELECT * FROM V_GIANGVIEN
-- CAU 4
-- KEY WORD TOP -> ORDER BY 

CREATE VIEW TOP2GV
AS
SELECT TOP 2 M.MAGIANGVIEN, GV.TENGIANGVIEN, COUNT(M.MAHOIDONG) AS SOLANTHAMGIA
FROM GIANGVIEN GV JOIN DanhSachHoiDong M ON GV.MAGIANGVIEN = M.MAGIANGVIEN
GROUP BY M.MAGIANGVIEN, GV.TENGIANGVIEN
ORDER BY COUNT(M.MAHOIDONG) DESC

SELECT * FROM TOP2GV
--CAU 5
-- INPUT LA 1 CHUOI KY TU -> OUTPUT : 1 DOAN KY TU TRONG CHUOI
--SUBSTRING(INPUT,VI TRI BAT DAU,7)
--HUONGTTM   SUBSTRING(NAME,1,5)
-- CHARINDEX - TIM VI TRI CUA MOT CHUOI CON TRONG CHUOI LON -> TRA VE VI TRI -- CHARINDEX(KY TU MUON TIM,CHUOI BO,1)
-- NGUYENVV6@GMAIL.COM -> 10
-- HAHQ11@FE.EDU.VN ->7

CREATE FUNCTION DBO.TIMEMAIL(
@EMAIL VARCHAR(50)
)
RETURNS VARCHAR(20)
AS 
BEGIN
	DECLARE @TENTAIKHOAN VARCHAR(20);
	SET @TENTAIKHOAN = SUBSTRING(@EMAIL,1,CHARINDEX('@', @EMAIL)-1);
RETURN @TENTAIKHOAN ;
END

SELECT DBO.TIMEMAIL('NGUYENVV6@FE.EDU.VN') AS ACCOUNT
-- BEGIN TRANSACTION, ROLLBACK-CANCEL,FAIL , COMMIT- SUCCESS, OK 
-- CAU 6
CREATE PROCEDURE XOAGV
@MaGiangVien INT
AS 
BEGIN 
	BEGIN TRY
	BEGIN TRANSACTION
	IF NOT EXISTS (SELECT 1 FROM GIANGVIEN WHERE MAGIANGVIEN = @MaGiangVien)
	BEGIN 
	
	    ROLLBACK TRANSACTION
		PRINT 'GIANG VIEN KHONG TON TAI, VUI LONG THU LAI'
	END
	ELSE 
	BEGIN 
		DELETE FROM GIANGVIEN WHERE MaGiangVien = @MaGiangVien 
		DELETE FROM DanhSachHoiDong  WHERE MaGiangVien = @MaGiangVien 
		COMMIT TRANSACTION 
	END
	
	END TRY 
	BEGIN CATCH
	ROLLBACK TRANSACTION 
    --PRINT 'XOA KHONG DUOC'
	DECLARE @ERROR VARCHAR(1000)
	SET @ERROR = ERROR_MESSAGE()
	PRINT 'LOI CUA BAN LA ' + @ERROR ;
	END CATCH 
END

EXEC XOAGV 1000


